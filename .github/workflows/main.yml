name: "Run Tests on Comment"
on:
  issue_comment:
    types: [created]

jobs:
  get-pr-commit-data:
    name: Get Latest PR Commit SHA
    if: github.event.issue.pull_request && contains(github.event.comment.body, '/test')
    runs-on: ubuntu-latest
    outputs:
      pr-sha: ${{ steps.pr-comment-commit-data.outputs.head_sha }}
      pr-ref: ${{ steps.pr-comment-commit-data.outputs.head_ref }}
    steps:
      - name: Get Comment Branch SHA
        uses: xt0rted/pull-request-comment-branch@v1
        id: pr-comment-commit-data

  tests-job:
    name: Tests Job
    runs-on: ubuntu-latest
    needs: get-pr-commit-data
    if: github.event.issue.pull_request && contains(github.event.comment.body, '/test')
    steps:
      - name: Tests Step
        run: echo "MAIN.YML Tests step for ${{ needs.get-pr-commit-data.outputs.pr-sha }}"
  
  other-job:
    name: Other Job
    if: github.event.issue.pull_request && contains(github.event.comment.body, '/test')
    runs-on: ubuntu-latest
    needs: [get-pr-commit-data, tests-job]
    steps:
      - name: get the one latest&last sha # get the last commit sha in pull_Requst
        env:
          PRSHA: ${{ needs.get-pr-commit-data.outputs.pr-sha}} 
        run: |
          URL=${{ github.event.issue.pull_request.url }}/commits
          echo "PRSHA=${{ needs.get-pr-commit-data.outputs.pr-sha }}"
      - name: echo PRSHA # check the lastest SHA
        run: |
          echo $PRSHA
      - name: create the status # create the status on the lastest commit sha from pull request
        run: |
          curl -X POST -u "citybasecnocon:${{ secrets.REPO_ACCESS_TOKEN }}" -H "Content-Type: application/json" "https://api.github.com/repos/${{ github.repository }}/statuses/$PRSHA" --data '{ "state": ${{ job.status }}, "target_url": "https://example.com/build/status", "description": "The build failed!", "context": "continuous-integration/statuscreation7"}'
  
  # other-job:
  #   name: Other Job
  #   if: github.event.issue.pull_request && contains(github.event.comment.body, '/test')
  #   runs-on: ubuntu-latest
  #   needs: [get-pr-commit-data, tests-job]
  #   steps:
  #     - name: Update Commit Status to Job Status
  #       uses: myrotvorets/set-commit-status-action@master
  #       if: always()
  #       with:
  #         status: ${{ job.status }}
  #         sha: ${{ needs.get-pr-commit-data.outputs.pr-sha }}
  #         token: ${{ secrets.REPO_ACCESS_TOKEN }}